<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="description" content="Bacaan bilal sholat tarawih 11 rakaat (8 tarawih + 3 witir) lengkap dengan arab, latin, terjemahan, audio, dan mode Bilal/Jamaah." />
	<meta name="keywords" content="tarawih, bilal, shalawat, witir, doa kamilin, bacaan arab, latin, terjemahan" />
	<meta name="robots" content="index, follow" />
	<meta property="og:title" content="Bacaan Bilal Sholat Tarawih 11 Rakaat" />
	<meta property="og:description" content="Bacaan bilal tarawih 11 rakaat lengkap dengan arab, latin, terjemahan, audio, dan mode Bilal/Jamaah." />
	<meta property="og:type" content="website" />
	<meta property="og:image" content="icons/icon.svg" />
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:title" content="Bacaan Bilal Sholat Tarawih 11 Rakaat" />
	<meta name="twitter:description" content="Bacaan bilal tarawih 11 rakaat lengkap dengan arab, latin, terjemahan, audio, dan mode Bilal/Jamaah." />
	<meta name="theme-color" content="#0b0f1a" />
	<link rel="manifest" href="manifest.json" />
	<link rel="icon" href="icons/icon.svg" type="image/svg+xml" />
	<title>Bacaan Bilal Sholat Tarawih</title>
	<script type="application/ld+json">
		{
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "Bacaan Bilal Sholat Tarawih",
			"url": "./",
			"description": "Bacaan bilal sholat tarawih 11 rakaat (8 tarawih + 3 witir) lengkap dengan arab, latin, terjemahan, audio, dan mode Bilal/Jamaah."
		}
	</script>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
	<style>
		@font-face {
			font-family: "ArabicUI";
			src: url("font.woff2") format("woff2");
			font-weight: 400 700;
			font-display: swap;
		}

		:root {
			color-scheme: dark;
			--bg: #0b0f1a;
			--bg-main: radial-gradient(circle at 22% 18%, rgba(140, 170, 210, 0.14), transparent 30%),
									radial-gradient(circle at 78% 12%, rgba(90, 120, 170, 0.12), transparent 34%),
									linear-gradient(150deg, #0a0f1d, #0e1627 55%, #080c15 100%);
			--texture: radial-gradient(circle at 24% 34%, rgba(255, 255, 255, 0.08) 0, rgba(255, 255, 255, 0.08) 9px, transparent 16px),
									radial-gradient(circle at 70% 58%, rgba(255, 255, 255, 0.06) 0, rgba(255, 255, 255, 0.06) 11px, transparent 18px),
									radial-gradient(circle at 42% 78%, rgba(255, 255, 255, 0.05) 0, rgba(255, 255, 255, 0.05) 14px, transparent 22px),
									repeating-radial-gradient(circle at 60% 24%, rgba(255, 255, 255, 0.04) 0 2px, transparent 3px 12px);
			--card: rgba(255, 255, 255, 0.06);
			--card-border: rgba(255, 255, 255, 0.08);
			--text: #e8edf6;
			--muted: #b7c3d6;
			--accent: #9ac7ff;
			--accent-2: #70e3ff;
			--shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
			--arabic-size: 22px;
			--arabic-color: #fefefe;
			--arabic-bg: rgba(255, 255, 255, 0.04);
			--arabic-border: rgba(255, 255, 255, 0.08);
			--hero-bg: linear-gradient(135deg, rgba(140, 180, 240, 0.22), rgba(8, 18, 32, 0.92));
			--hero-border: rgba(255, 255, 255, 0.08);
			--hero-title: #f4f7fb;
			--button-bg: linear-gradient(135deg, rgba(154, 199, 255, 0.24), rgba(10, 20, 40, 0.8));
			--button-border: rgba(255, 255, 255, 0.16);
			--button-text: #e8f2ff;
			--badge-bg: linear-gradient(135deg, rgba(154, 199, 255, 0.22), rgba(14, 26, 48, 0.9));
			--badge-border: rgba(255, 255, 255, 0.16);
			--badge-text: #eaf2ff;
			--role-muted: rgba(232, 237, 246, 0.55);
			--role-strong: rgba(232, 237, 246, 1);
			--texture-opacity: 0.55;
			--texture-size: 420px 420px;
		}

		[data-theme="light"] {
			color-scheme: light;
			--bg: #fff6e3;
			--bg-main: radial-gradient(circle at 20% 18%, rgba(255, 204, 128, 0.28), transparent 30%),
									radial-gradient(circle at 80% 12%, rgba(255, 160, 122, 0.22), transparent 36%),
									radial-gradient(circle at 50% 72%, rgba(255, 226, 170, 0.18), transparent 40%),
									linear-gradient(145deg, #fff6e3, #ffe8c7 60%, #fff7ea 100%);
			--texture: radial-gradient(circle at 26% 30%, rgba(255, 190, 110, 0.22) 0, rgba(255, 190, 110, 0.22) 16px, transparent 26px),
									radial-gradient(circle at 66% 44%, rgba(255, 170, 90, 0.18) 0, rgba(255, 170, 90, 0.18) 14px, transparent 24px),
									radial-gradient(circle at 54% 64%, rgba(255, 214, 140, 0.16) 0, rgba(255, 214, 140, 0.16) 22px, transparent 32px),
									repeating-radial-gradient(circle at 58% 22%, rgba(255, 210, 120, 0.12) 0 3px, transparent 5px 14px);
			--card: rgba(255, 255, 255, 0.92);
			--card-border: rgba(180, 120, 60, 0.18);
			--text: #2c1c0f;
			--muted: #5a4030;
			--accent: #d66a00;
			--accent-2: #ffb347;
			--shadow: 0 18px 42px rgba(150, 90, 20, 0.14);
			--arabic-color: #2c1c0f;
			--arabic-bg: rgba(0, 0, 0, 0.04);
			--arabic-border: rgba(0, 0, 0, 0.08);
			--hero-bg: linear-gradient(140deg, rgba(255, 196, 128, 0.28), rgba(255, 236, 210, 0.9));
			--hero-border: rgba(180, 120, 60, 0.14);
			--hero-title: #2c1c0f;
			--button-bg: linear-gradient(135deg, rgba(255, 199, 134, 0.5), rgba(255, 236, 210, 0.9));
			--button-border: rgba(180, 120, 60, 0.32);
			--button-text: #2c1c0f;
			--badge-bg: linear-gradient(135deg, rgba(255, 210, 140, 0.56), rgba(255, 234, 210, 0.92));
			--badge-border: rgba(180, 120, 60, 0.32);
			--badge-text: #2c1c0f;
			--role-muted: rgba(44, 28, 15, 0.6);
			--role-strong: rgba(44, 28, 15, 1);
			--texture-opacity: 0.58;
			--texture-size: 360px 360px;
		}

		* { box-sizing: border-box; margin: 0; padding: 0; }

		body {
			min-height: 100vh;
			font-family: "Manrope", system-ui, -apple-system, sans-serif;
			background: var(--bg-main);
			color: var(--text);
			padding: 32px 18px 48px;
			display: flex;
			justify-content: center;
			transition: background 280ms ease, color 200ms ease;
			position: relative;
			overflow-x: hidden;
		}

		body::after {
			content: "";
			position: fixed;
			inset: 0;
			background-image: var(--texture);
			background-size: var(--texture-size);
			opacity: var(--texture-opacity);
			pointer-events: none;
			mix-blend-mode: overlay;
			z-index: 0;
		}

		.page {
			width: min(1100px, 100%);
			display: flex;
			flex-direction: column;
			gap: 22px;
			position: relative;
			z-index: 1;
		}

		.hero {
			position: relative;
			padding: 28px 26px;
			border-radius: 18px;
			background: var(--hero-bg);
			border: 1px solid var(--hero-border);
			overflow: hidden;
			box-shadow: var(--shadow);
			transition: transform 200ms ease, box-shadow 200ms ease;
		}

		.hero::after {
			content: "";
			position: absolute;
			inset: 0;
			background: radial-gradient(circle at 70% 0%, rgba(255, 255, 255, 0.2), transparent 35%);
			pointer-events: none;
		}

		.hero h1 {
			font-family: "Playfair Display", "Manrope", serif;
			letter-spacing: 0.4px;
			font-size: clamp(26px, 3vw, 34px);
			line-height: 1.3;
			margin-bottom: 8px;
			color: var(--hero-title);
		}

		.hero p {
			max-width: 780px;
			color: var(--muted);
			line-height: 1.6;
			font-size: 15px;
		}

		.hero:hover { transform: translateY(-2px); }

		.toolbar {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			margin-top: 14px;
			align-items: center;
		}

		.toolbar .group {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px 12px;
			border-radius: 12px;
			background: rgba(255, 255, 255, 0.06);
			border: 1px solid var(--card-border);
			color: var(--muted);
			font-size: 13px;
		}

		.group.bilal-only { display: none; }
		body[data-mode="bilal"] .group.bilal-only { display: flex; }

		.toolbar label { font-weight: 600; color: var(--text); }

		.toolbar input[type="range"] {
			accent-color: var(--accent);
			cursor: pointer;
		}

		.toolbar button {
			appearance: none;
			border: 1px solid var(--button-border);
			background: var(--button-bg);
			color: var(--button-text);
			padding: 10px 14px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: transform 120ms ease, border-color 120ms ease, background 180ms ease;
		}

		.mode-btn {
			padding: 8px 12px;
			font-weight: 700;
			border-radius: 10px;
			border: 1px solid var(--button-border);
			background: rgba(255, 255, 255, 0.05);
			color: var(--text);
			transition: transform 120ms ease, border-color 120ms ease, background 180ms ease;
		}

		.mode-btn.active {
			background: var(--button-bg);
			color: var(--button-text);
			border-color: var(--button-border);
			transform: translateY(-1px);
			box-shadow: 0 0 0 1px rgb(255, 255, 255), 0 8px 18px rgb(0, 0, 0);
		}

		.toolbar button:hover { transform: translateY(-1px); border-color: rgba(255, 255, 255, 0.2); }
		.toolbar button:active { transform: translateY(0); }

		.cards {
			display: grid;
			grid-template-columns: 1fr;
			gap: 18px;
			align-items: start;
			max-width: 740px;
			margin: 0 auto;
		}

		.card {
			background: var(--card);
			border: 1px solid var(--card-border);
			border-radius: 16px;
			padding: 20px 20px 18px;
			box-shadow: var(--shadow);
			backdrop-filter: blur(10px);
			display: flex;
			flex-direction: column;
			gap: 12px;
			position: relative;
			overflow: hidden;
			transition: transform 180ms ease, border-color 180ms ease, box-shadow 180ms ease;
			height: 100%;
		}

		.card::before {
			content: "";
			position: absolute;
			inset: 0;
			background: radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.08), transparent 30%);
			opacity: 0;
			transition: opacity 200ms ease;
			pointer-events: none;
		}

		.card:hover { transform: translateY(-3px); border-color: rgba(255, 255, 255, 0.16); box-shadow: 0 16px 36px rgba(0, 0, 0, 0.28); }
		.card:hover::before { opacity: 1; }

		.card-head {
			display: flex;
			gap: 12px;
			align-items: flex-start;
			justify-content: space-between;
		}

		.badge {
			min-width: 34px;
			height: 34px;
			border-radius: 10px;
			background: var(--badge-bg);
			border: 1px solid var(--badge-border);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: var(--badge-text);
			box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
			font-size: 14px;
		}

		.role { display: inline-block; color: var(--role-strong); opacity: 1; }
		.role-neutral { color: var(--text); opacity: 1; }
		.role-together { color: var(--role-strong); opacity: 1 !important; }

		body[data-mode="jamaah"] .role-bilal,
		body[data-mode="jamaah"] .role-bilal2 {
			opacity: 0.4;
			color: var(--role-muted);
		}
		body[data-mode="jamaah"] .role-jamaah { opacity: 1; color: var(--role-strong); }

		body[data-mode="bilal"][data-bilal-variant="bilal1"] .role-bilal { opacity: 1; color: var(--role-strong); }
		body[data-mode="bilal"][data-bilal-variant="bilal1"] .role-bilal2,
		body[data-mode="bilal"][data-bilal-variant="bilal1"] .role-jamaah {
			opacity: 0.4;
			color: var(--role-muted);
		}

		body[data-mode="bilal"][data-bilal-variant="bilal2"] .role-bilal2 { opacity: 1; color: var(--role-strong); }
		body[data-mode="bilal"][data-bilal-variant="bilal2"] .role-bilal,
		body[data-mode="bilal"][data-bilal-variant="bilal2"] .role-jamaah {
			opacity: 0.4;
			color: var(--role-muted);
		}

		body[data-mode="bilal"][data-bilal-variant="solo"] .role-bilal,
		body[data-mode="bilal"][data-bilal-variant="solo"] .role-bilal2 { opacity: 1; color: var(--role-strong); }
		body[data-mode="bilal"][data-bilal-variant="solo"] .role-jamaah {
			opacity: 0.4;
			color: var(--role-muted);
		}

		.judul {
			font-weight: 700;
			color: var(--text);
			font-size: 15px;
			line-height: 1.4;
		}

		.arabic {
			font-family: "ArabicUI", "Scheherazade", serif;
			font-size: clamp(12px, var(--arabic-size), 64px);
			line-height: 1.7;
			color: var(--arabic-color);
			text-align: right;
			direction: rtl;
			background: var(--arabic-bg);
			border-radius: 12px;
			padding: 12px;
			border: 1px solid var(--arabic-border);
		}

		.latin, .translate {
			color: var(--muted);
			line-height: 1.6;
			font-size: 14px;
		}

		.latin strong { color: var(--text); }

		.controls {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
			align-items: center;
			justify-content: flex-end;
		}

		.floating-toggle {
			position: fixed;
			right: 18px;
			bottom: 18px;
			z-index: 30;
			appearance: none;
			border: 1px solid var(--button-border);
			background: var(--button-bg);
			color: var(--button-text);
			padding: 12px 14px;
			border-radius: 14px;
			font-weight: 800;
			cursor: pointer;
			box-shadow: var(--shadow);
			opacity: 0;
			pointer-events: none;
			transform: translateY(8px);
			transition: opacity 160ms ease, transform 160ms ease, border-color 160ms ease;
		}

		body.floating-active .floating-toggle {
			opacity: 1;
			pointer-events: auto;
			transform: translateY(0);
		}

		.floating-toggle:hover { border-color: rgba(255, 255, 255, 0.2); }
		.floating-toggle:active { transform: translateY(1px); }

		.floating-panel {
			position: fixed;
			right: 18px;
			bottom: 74px;
			z-index: 28;
			width: min(420px, calc(100% - 32px));
			background: var(--card);
			border: 1px solid var(--card-border);
			border-radius: 16px;
			box-shadow: var(--shadow);
			padding: 12px;
			opacity: 0;
			pointer-events: none;
			transform: translateY(10px);
			transition: opacity 160ms ease, transform 160ms ease;
		}

		.floating-panel.open {
			opacity: 1;
			pointer-events: auto;
			transform: translateY(0);
		}

		.floating-panel .toolbar {
			margin-top: 0;
			background: transparent;
			border: none;
			padding: 0;
			flex-direction: column;
			align-items: stretch;
			gap: 10px;
		}

		.floating-panel .toolbar .group {
			width: 100%;
			justify-content: space-between;
		}

		.witir-note {
			display: flex;
			gap: 8px;
			align-items: center;
			margin-top: 6px;
			padding: 10px 12px;
			border-radius: 12px;
			border: 1px dashed var(--card-border);
			background: rgba(255, 255, 255, 0.04);
			color: var(--text);
			font-size: 13px;
		}

		.witir-pill {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 6px;
			background: transparent;
			border: 1px solid var(--card-border);
			color: var(--muted);
			font-weight: 600;
			font-size: 13px;
			line-height: 1;
			vertical-align: middle;
		}

		button.audio-btn {
			appearance: none;
			border: 1px solid var(--button-border);
			background: var(--button-bg);
			color: var(--button-text);
			padding: 10px 14px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 120ms ease, border-color 120ms ease, background 180ms ease;
		}

		button.audio-btn:hover { transform: translateY(-1px); border-color: rgba(255, 255, 255, 0.2); }
		button.audio-btn:active { transform: translateY(0); }
		button.audio-btn:disabled {
			cursor: not-allowed;
			opacity: 0.55;
			background: rgba(0, 0, 0, 0.06);
		}

		.empty {
			grid-column: 1 / -1;
			text-align: center;
			color: var(--muted);
			padding: 32px;
			border: 1px dashed rgba(255, 255, 255, 0.15);
			border-radius: 12px;
			background: rgba(255, 255, 255, 0.03);
		}

		.spark {
			position: fixed;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			pointer-events: none;
			background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(141, 208, 245, 0.1));
			box-shadow: 0 0 12px rgba(141, 208, 245, 0.8);
			animation: spark 600ms ease-out forwards;
			mix-blend-mode: screen;
		}

		@keyframes spark {
			0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
			60% { transform: translate(-50%, -50%) scale(1.8); opacity: 0.7; }
			100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; }
		}

		@media (max-width: 640px) {
			body { padding: 22px 14px 34px; }
			.card { padding: 16px; }
		}

		.footer {
			margin-top: 10px;
			color: var(--muted);
			font-size: 13px;
			text-align: center;
			line-height: 1.5;
		}

		.footer a { color: var(--accent); text-decoration: none; }
		.footer a:hover { text-decoration: underline; }
	</style>
</head>
<body>
	<main class="page">
		<section class="hero">
			<h1 id="app-title">Bacaan Bilal Sholat Tarawih</h1>
			<p id="app-desc">Susunan bacaan bilal tarawih 11 rakaat (8 tarawih + 3 witir), lengkap dengan teks Arab, latin, terjemahan, dan tautan audio jika tersedia. Kontrol audio: tekan 1x mulai/jeda, 3x reset.</p>
			<div class="toolbar">
				<div class="group">
					<label for="font-range">Ukuran Arab</label>
					<input id="font-range" type="range" min="12" max="64" value="22" />
				</div>
				<div class="group">
					<label for="theme-toggle">Tema</label>
					<button id="theme-toggle" type="button">Mode Gelap</button>
				</div>
				<div class="group">
					<span>Mode</span>
					<button class="mode-btn" data-mode="bilal" type="button">Bilal</button>
					<button class="mode-btn" data-mode="jamaah" type="button">Jamaah</button>
				</div>
				<div class="group bilal-only">
					<span>Mode Bilal</span>
					<button class="mode-btn" data-bilal-variant="solo" type="button">Solo</button>
					<button class="mode-btn" data-bilal-variant="bilal1" type="button">Bilal 1</button>
					<button class="mode-btn" data-bilal-variant="bilal2" type="button">Bilal 2</button>
				</div>
				<div class="group">
					<span>Witir</span>
					<button class="mode-btn witir-btn" data-witir="3" type="button">3</button>
					<button class="mode-btn witir-btn" data-witir="2-1" type="button">2+1</button>
				</div>
			</div>
		</section>

		<section id="cards" class="cards" aria-live="polite">
			<div class="empty">Memuat data...</div>
		</section>

		<footer class="footer" id="footer"></footer>
	</main>

	<script>
		const state = {
			theme: localStorage.getItem('theme') || 'dark',
			arabicSize: Number(localStorage.getItem('arabicSize') || 22),
			mode: localStorage.getItem('mode') || 'bilal',
			witirMode: localStorage.getItem('witirMode') || '3',
			bilalVariant: localStorage.getItem('bilalVariant') || 'bilal1',
		};

		let dataCache = null;
		const player = { audio: null, btn: null, lastClick: 0, src: '' };

		async function loadData() {
			try {
				const res = await fetch('data.json');
				if (!res.ok) throw new Error('Gagal memuat data');
				const data = await res.json();
				dataCache = data;
				render(data);
			} catch (err) {
				const cards = document.getElementById('cards');
				cards.innerHTML = '<div class="empty">Tidak dapat memuat data.</div>';
				console.error(err);
			}
		}

		function registerSW() {
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('service-worker.js').catch(() => {
					console.warn('Service worker registration failed');
				});
			}
		}

		function render(data) {
			const cards = document.getElementById('cards');
			const title = document.getElementById('app-title');
			const desc = document.getElementById('app-desc');
			title.textContent = data.appTitle || 'Bacaan Bilal Sholat Tarawih';
			desc.textContent = data.appDescription || 'Susunan bacaan bilal tarawih 11 rakaat (8 tarawih + 3 witir), lengkap dengan teks Arab, latin, terjemahan, dan tautan audio jika tersedia. Kontrol audio: tekan 1x mulai/jeda, 3x reset.';
			const footer = document.getElementById('footer');
			const parts = [];
			const sources = Array.isArray(data.source) ? data.source : (data.source ? [data.source] : []);
			const witir3HiddenIds = Array.isArray(data.witir3HiddenIds)
				? data.witir3HiddenIds.map((v) => Number(v)).filter((v) => Number.isFinite(v))
				: [7];
			if (sources.length) {
				const links = sources.map((s) => `<a href="${s}" target="_blank" rel="noopener">${s}</a>`).join(', ');
				parts.push(`Sumber: ${links}`);
			}
			if (data.lastUpdated) parts.push(`Dibuat: ${data.lastUpdated}`);
			footer.innerHTML = parts.join(' ‚Ä¢ ');

			const items = (data.items || []).filter(item => {
				if (state.witirMode === '3' && witir3HiddenIds.includes(item.id)) return false;
				return true;
			});

			if (!items.length) {
				cards.innerHTML = '<div class="empty">Belum ada bacaan.</div>';
				return;
			}

			cards.innerHTML = items.map(item => {
				const audioSrc = resolveAudio(item.audio);
				const hasAudio = Boolean(audioSrc);
				const fallbackRole = item.id === 5 ? 'bilal' : '';
				const arabHtml = decorateLines(item.arab, true, fallbackRole);
				const latinHtml = decorateLines(item.latin, false, fallbackRole);
				const terjemahHtml = decorateLines(item.terjemahan, false, fallbackRole);
				const witirNote = item.id === 6 ? buildWitirNote() : '';
				return `
					<article class="card">
						<div class="card-head">
							<span class="badge">${item.id ?? ''}</span>
							<div class="judul">${item.judul || ''}</div>
						</div>
						<div class="arabic">${arabHtml}</div>
						<div class="latin"><strong>Latin:</strong> ${latinHtml}</div>
						<div class="translate"><strong>Terjemahan:</strong> ${terjemahHtml}</div>
						${witirNote}
						<div class="controls">
							<button class="audio-btn" ${hasAudio ? '' : 'disabled'} data-audio="${audioSrc}">
								${hasAudio ? 'Putar audio' : 'Audio belum tersedia'}
							</button>
						</div>
					</article>
				`;
			}).join('');

			cards.querySelectorAll('.audio-btn').forEach(btn => {
				btn.addEventListener('click', () => handleAudioClick(btn));
			});
		}

		function applyTheme() {
			document.documentElement.setAttribute('data-theme', state.theme);
			const btn = document.getElementById('theme-toggle');
			btn.textContent = state.theme === 'dark' ? 'Mode Gelap' : 'Mode Terang';
		}

		function applyFontSize() {
			const clamped = Math.min(Math.max(state.arabicSize, 12), 64);
			state.arabicSize = clamped;
			localStorage.setItem('arabicSize', clamped);
			document.documentElement.style.setProperty('--arabic-size', `${clamped}px`);
			document.getElementById('font-range').value = clamped;
		}

		function applyMode() {
			document.body.setAttribute('data-mode', state.mode);
			document.querySelectorAll('.mode-btn[data-mode]').forEach(btn => {
				btn.classList.toggle('active', btn.dataset.mode === state.mode);
			});
			localStorage.setItem('mode', state.mode);
			if (dataCache) render(dataCache);
		}

		function applyBilalVariant() {
			const variant = ['solo', 'bilal1', 'bilal2'].includes(state.bilalVariant) ? state.bilalVariant : 'bilal1';
			state.bilalVariant = variant;
			document.body.setAttribute('data-bilal-variant', variant);
			document.querySelectorAll('.mode-btn[data-bilal-variant]').forEach(btn => {
				btn.classList.toggle('active', btn.dataset.bilalVariant === variant);
			});
			localStorage.setItem('bilalVariant', variant);
			if (dataCache && state.mode === 'bilal') render(dataCache);
		}

		function applyWitirMode() {
			document.body.setAttribute('data-witir', state.witirMode);
			document.querySelectorAll('.witir-btn').forEach(btn => {
				btn.classList.toggle('active', btn.dataset.witir === state.witirMode);
			});
			localStorage.setItem('witirMode', state.witirMode);
			if (dataCache) render(dataCache);
		}

		function setupControls() {
			const fontRange = document.getElementById('font-range');
			fontRange.addEventListener('input', (e) => {
				state.arabicSize = Number(e.target.value);
				localStorage.setItem('arabicSize', state.arabicSize);
				applyFontSize();
			});

			const themeBtn = document.getElementById('theme-toggle');
			themeBtn.addEventListener('click', () => {
				state.theme = state.theme === 'dark' ? 'light' : 'dark';
				localStorage.setItem('theme', state.theme);
				applyTheme();
			});

			document.querySelectorAll('.mode-btn[data-bilal-variant]').forEach(btn => {
				btn.addEventListener('click', () => {
					state.bilalVariant = btn.dataset.bilalVariant;
					applyBilalVariant();
				});
			});

			document.querySelectorAll('.mode-btn[data-mode]').forEach(btn => {
				btn.addEventListener('click', () => {
					state.mode = btn.dataset.mode;
					applyMode();
				});
			});

			document.querySelectorAll('.witir-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					state.witirMode = btn.dataset.witir;
					applyWitirMode();
				});
			});
		}

		function spawnSpark(x, y) {
			const spark = document.createElement('span');
			spark.className = 'spark';
			spark.style.left = `${x}px`;
			spark.style.top = `${y}px`;
			document.body.appendChild(spark);
			setTimeout(() => spark.remove(), 650);
		}

		function setupSparks() {
			let last = 0;
			window.addEventListener('mousemove', (e) => {
				const now = Date.now();
				if (now - last > 45) {
					spawnSpark(e.clientX, e.clientY);
					last = now;
				}
			});

			window.addEventListener('scroll', () => {
				const x = window.innerWidth * Math.random();
				const y = (window.innerHeight * 0.25) + Math.random() * 80;
				spawnSpark(x, y);
			}, { passive: true });
		}

		function setupFloatingToolbar() {
			const hero = document.querySelector('.hero');
			const toolbar = document.querySelector('.toolbar');
			if (!hero || !toolbar) return;

			const placeholder = document.createElement('div');
			placeholder.id = 'toolbar-placeholder';
			placeholder.style.display = 'none';
			placeholder.style.width = '100%';
			placeholder.style.pointerEvents = 'none';

			const floatingBtn = document.createElement('button');
			floatingBtn.type = 'button';
			floatingBtn.className = 'floating-toggle';
			floatingBtn.setAttribute('aria-label', 'Buka pengaturan');
			floatingBtn.textContent = 'üõ†Ô∏è';

			const floatingPanel = document.createElement('div');
			floatingPanel.className = 'floating-panel';
			floatingPanel.setAttribute('aria-live', 'polite');

			document.body.appendChild(floatingBtn);
			document.body.appendChild(floatingPanel);

			let open = false;

			function updatePlaceholderSize() {
				const rect = toolbar.getBoundingClientRect();
				const styles = getComputedStyle(toolbar);
				placeholder.style.height = `${rect.height}px`;
				placeholder.style.marginTop = styles.marginTop;
				placeholder.style.marginBottom = styles.marginBottom;
			}

			function moveToolbarToPanel() {
				if (floatingPanel.contains(toolbar)) return;
				updatePlaceholderSize();
				hero.replaceChild(placeholder, toolbar);
				floatingPanel.appendChild(toolbar);
				placeholder.style.display = 'block';
			}

			function restoreToolbar() {
				if (!floatingPanel.contains(toolbar)) return;
				floatingPanel.removeChild(toolbar);
				hero.replaceChild(toolbar, placeholder);
				placeholder.style.display = 'none';
			}

			function closePanel() {
				floatingPanel.classList.remove('open');
				floatingBtn.setAttribute('aria-expanded', 'false');
				open = false;
				restoreToolbar();
			}

			function openPanel() {
				moveToolbarToPanel();
				floatingPanel.classList.add('open');
				floatingBtn.setAttribute('aria-expanded', 'true');
				open = true;
			}

			floatingBtn.addEventListener('click', () => {
				if (open) {
					closePanel();
					return;
				}
				openPanel();
			});

			window.addEventListener('resize', () => {
				if (!open) return;
				updatePlaceholderSize();
			});

			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && open) closePanel();
			});

			const observer = new IntersectionObserver((entries) => {
				const visible = entries.some(entry => entry.isIntersecting);
				if (visible) {
					document.body.classList.remove('floating-active');
					closePanel();
					return;
				}
				document.body.classList.add('floating-active');
			}, { threshold: 0.1 });

			observer.observe(hero);
		}

		function classifyRole(line) {
			const t = (line || '').trim().toLowerCase();
			if (t.includes('dibaca bersama')) return 'together';
			if (/^\s*2\s*bilal/.test(t) || t.includes('2 bilal') || t.includes('bilal 2') || t.includes('bilal kedua')) return 'bilal2';
			if (t.includes('potongan ayat') || t.includes('qs.') || t.includes('qs ')) return 'bilal2';
			if (t.includes('ÿßŸÑÿµŸéŸëŸÑŸéÿßÿ©Ÿè ŸÑŸéÿß ÿ•ŸêŸÑŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ÿßŸÑŸÑŸéŸëŸáŸè') || t.includes('ash-shalƒÅtu lƒÅ ilƒÅha illallƒÅh') || t.includes('ash-shalatu la ilaha illallah')) return 'jamaah';
			if (t.includes('tahlil') || t.includes('ŸÑŸéÿß ÿ•ŸêŸÑŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ÿßŸÑŸÑŸéŸëŸáŸè') || t.includes('ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá')) return 'neutral';
			if (t.includes('bilal (atau bersama-sama')) return 'neutral';
			if (t.startsWith('lalu diteruskan dengan bacaan tahlil')) return 'neutral';
			if (t.startsWith('jamaah')) return 'jamaah';
			if (t.includes('jamaah menjawab')) return 'jamaah';
			if (t.startsWith('bilal')) return 'bilal';
			if (t.startsWith('seruan bilal')) return 'bilal';
			if (t.startsWith('kemudian bilal')) return 'bilal';
			return '';
		}

		function resolveAudio(audioValue) {
			if (!audioValue) return '';
			if (typeof audioValue === 'string') return audioValue;
			if (typeof audioValue === 'object') {
				return audioValue[state.mode] || '';
			}
			return '';
		}

		function stopCurrent() {
			if (player.audio) {
				player.audio.pause();
				player.audio.currentTime = 0;
			}
			if (player.btn) player.btn.textContent = 'Putar audio';
			player.audio = null;
			player.btn = null;
			player.src = '';
		}

		function handleAudioClick(btn) {
			const src = btn.dataset.audio;
			if (!src) return;
			const now = Date.now();
			const rapidThreshold = 450;

			if (player.audio && player.src === src && player.btn === btn) {
				const delta = now - player.lastClick;
				player.lastClick = now;
				if (!player.audio.paused && delta < rapidThreshold) {
					stopCurrent();
					return;
				}
				if (player.audio.paused) {
					player.audio.play().catch(() => stopCurrent());
					btn.textContent = 'Jeda';
				} else {
					player.audio.pause();
					btn.textContent = 'Putar audio';
				}
				return;
			}

			stopCurrent();
			const audio = new Audio(src);
			player.audio = audio;
			player.btn = btn;
			player.src = src;
			player.lastClick = now;
			btn.textContent = 'Jeda';

			audio.addEventListener('ended', () => stopCurrent());
			audio.play().catch(() => {
				btn.textContent = 'Gagal memutar audio';
				btn.disabled = true;
				stopCurrent();
			});
		}

		function witirDescription() {
			return state.witirMode === '2-1'
				? '2 rakaat salam, lanjut 1 rakaat salam (dua salam).'
				: '3 rakaat sekali salam (satu salam).';
		}

		function buildWitirNote() {
			return `
				<div class="witir-note">
					<span class="witir-pill">Mode Witir dipilih:</span>
					<span>${witirDescription()}</span>
				</div>
			`;
		}

		function decorateLines(text, addCommas, fallbackRole = '') {
			const lines = (text || '').split(/\n+/).filter(l => l.trim().length > 0);
			let currentRole = fallbackRole;
			return lines.map((line, idx) => {
				const detected = classifyRole(line);
				if (detected) currentRole = detected;
				const role = currentRole;
				const comma = addCommas && idx < lines.length - 1 ? 'ÿå' : '';
				return `<span class="role ${role ? `role-${role}` : ''}">${line}${comma}</span>`;
			}).join('<br>');
		}

		applyTheme();
		applyFontSize();
		applyMode();
		applyWitirMode();
		applyBilalVariant();
		setupControls();
		setupSparks();
		setupFloatingToolbar();
		loadData();
		registerSW();
	</script>
</body>
</html>
